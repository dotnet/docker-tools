parameters:
- name: displayName
  type: string
  default: "Run ImageBuilder"
- name: serviceConnection
  type: string
  default: ""
- name: internalProjectName
  type: string
  default: null
- name: args
  type: string
  default: null
- name: continueOnError
  type: boolean
  default: false

steps:
- ${{ if and(eq(variables['System.TeamProject'], parameters.internalProjectName), ne(variables['Build.Reason'], 'PullRequest'), ne(parameters.serviceConnection, '')) }}:
  - task: AzureCLI@2
    displayName: ${{ parameters.displayName }}
    continueOnError: ${{ parameters.continueOnError }}
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      addSpnToEnvironment: true
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: >
        $(runAuthedImageBuilderCmd)
        ${{ parameters.args }}
- ${{ else }}:
  - task: CmdLine@2
    displayName: ${{ parameters.displayName }}
    continueOnError: ${{ parameters.continueOnError }}
    inputs:
      script: >
        $(runImageBuilderCmd)
        ${{ parameters.args }}
