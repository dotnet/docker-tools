# Bootstrap ImageBuilder by building it from source.
# This template builds ImageBuilder directly from source code, bypassing the need
# to pull a pre-built image.
#
# On Linux: Builds the Docker image using Dockerfile.linux
# On Windows: Installs dotnet SDK and builds locally with dotnet publish
#             (since Windows runs the exe directly, not in a container)
#
# The result is tagged/placed so that subsequent steps work without modification.

steps:
- script: >-
    docker build -t $(imageNames.imageBuilder) -f src/Dockerfile.linux src/
  displayName: Bootstrap ImageBuilder from source (Linux)
  condition: eq(variables['Agent.OS'], 'Linux')

- pwsh: >-
    $(engDockerToolsPath)/Install-DotNetSdk.ps1 -InstallPath "$(Build.SourcesDirectory)/.dotnet"
  displayName: Install .NET SDK (Windows)
  condition: eq(variables['Agent.OS'], 'Windows_NT')

- pwsh: >-
    $(Build.SourcesDirectory)/.dotnet/dotnet
      publish
      src/ImageBuilder/Microsoft.DotNet.ImageBuilder.csproj
      --self-contained
      -o $(Build.BinariesDirectory)/.Microsoft.DotNet.ImageBuilder
  displayName: Bootstrap ImageBuilder from source (Windows)
  condition: eq(variables['Agent.OS'], 'Windows_NT')
